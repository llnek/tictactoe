require(["use!jquery","use!underscore","use!backbone",],function(i,m,l,e){function k(q){return typeof q!=="undefined"&&q!==null}var d=0,h=1,p=2,f=60,c="#fff",o="#8ADE35",b="#F59631";var a,g,j,n;a=(function(){function q(s,t,r){this.x=s;this.y=t;this.radius=r}q.prototype.draw=function(r,s){r.beginPath();r.strokeStyle=s.stroke.style;r.lineWidth=s.line.width;r.arc(this.x,this.y,this.radius,0,2*Math.PI,true);return r.stroke()};return q})();g=(function(){function q(s,u,r,t){this.x1=s;this.y1=u;this.x2=r;this.y2=t}q.prototype.draw=function(r,s){r.beginPath();r.moveTo(this.x1,this.y1);r.lineTo(this.x2,this.y2);r.strokeStyle=s.stroke.style;r.lineWidth=s.line.width;if(s.line.cap!=null){r.lineCap=s.line.cap}return r.stroke()};return q})();j=(function(){function q(){this.font="14px 'Architects Daughter'";this.fill="#dddddd";this.align="left";this.base="top"}return q})();n=(function(){function q(r,s){this.size=r!=null?r:3;this.players=s!=null?s:1;this.cells=this.size*this.size;this.X=this.size*-1;this.O=this.size;this.layers=m.map(["bg","ui","game"],function(t){return i("#tictactoe #"+t)[0].getContext("2d")});this.mapGoalSpace()}q.prototype.cls=function(r){return r.clearRect(0,0,r.canvas.width,r.canvas.height)};q.prototype.loadAssets=function(){var r,u,t,s;r=i.Deferred();u=this;t=function(v){return alert("dude, no good\n"+v)};s=function(){return u.build()};this.scoreX=0;this.scoreO=0;this.bgImg=new Image();this.bgImg.onerror=function(){return r.reject("Error while loading background image")};this.bgImg.onload=function(){return r.resolve()};this.bgImg.src="/public/images/bg.png";return i.when(r.promise()).then(s,t)};q.prototype.inizEvents=function(){var r,s;r=i("#tictactoe #layers");s=this;r.mousedown(function(t){return s.onLeftMouseDown(t)});i("#tictactoe #play").on("click",function(){return s.onPlay()});return i("#tictactoe #stop").on("click",function(){return s.onStop()})};q.prototype.build=function(){this.showBackdrop();this.inizEvents();return this.readyForGame()};q.prototype.readyForGame=function(){this.gameInProgress=false;this.maybeEnableInputs();this.clsArena();return this.showMsg("Ready for a quick game with our Cyborg? ")};q.prototype.onLeftMouseDown=function(s){var v,u,r,t;if(this.gameInProgress&&this.curActor===this.X){t=this.offset(s),v=t[0],u=t[1];r=this.checkOffset(v,u);if(k(r)){return this.checkInput(r)}}};q.prototype.onPlay=function(){var s,r,t;if(this.gameInProgress!==true){t=this;this.gameInProgress=true;this.level=parseInt(i("#tictactoe #level").val(),10);this.inizGameData();this.clsArena();this.maybeDisableInputs();s=this.curActor===this.X?"You move":"Cyborg moves";this.showMsg("Game Started! "+s+" first ...");r=function(){if(t.curActor===t.O){return t.cyborgMove()}};return this.syncPlayerState(r)}};q.prototype.onStop=function(){if(this.gameInProgress===true){this.gameInProgress=false;if(this.curActor===this.X){return this.onStopReset()}}};q.prototype.onStopReset=function(){this.nukeGame();return this.showMsg("Game stopped.  Play a New Game ? ")};q.prototype.nukeGame=function(){this.gameInProgress=false;this.maybeEnableInputs();return this.clsStates()};q.prototype.checkWin=function(){var r;r=this.findWinner();if(r===this.X||r===this.O||r===911){return this.endGame(r)}else{return this.toggleActor()}};q.prototype.findWinner=function(){var A,r,C,B,y,x,v,t,z,w,u,s;C=0;for(A=y=0,z=this.cells;0<=z?y<z:y>z;A=0<=z?++y:--y){C+=this.grid[A];if(((A+1)%this.size)===0){B=this.matchXO(C);if(k(B)){return B}else{C=0}}}for(A=x=0,w=this.size;0<=w?x<w:x>w;A=0<=w?++x:--x){C=0;r=A;while(r<this.cells){C+=this.grid[r];r+=this.size}B=this.matchXO(C);if(k(B)){return B}}C=0;for(A=v=0,u=this.dx.length;0<=u?v<u:v>u;A=0<=u?++v:--v){C+=this.grid[this.dx[A]]}B=this.matchXO(C);if(k(B)){return B}C=0;for(A=t=0,s=this.dy.length;0<=s?t<s:t>s;A=0<=s?++t:--t){C+=this.grid[this.dy[A]]}B=this.matchXO(C);if(k(B)){return B}if(m.include(this.grid,0)){return null}else{return 911}};q.prototype.matchXO=function(r){switch(r){case this.X:return this.X;case this.O:return this.O;default:return null}};q.prototype.syncPlayerState=function(s){var t,z,r,w,u,A,v;v=this.clsStates(),t=v[0],A=v[1],u=v[2],w=v[3];this.styleText(t,new j());if(this.curActor===this.X){z="Your Turn...";r=u}else{z="Thinking...";r=w}return setTimeout(function(){t.fillText(z,r,A);return s()},500)};q.prototype.clsStates=function(){var r,u,t,s;r=this.layers[p];u=this.gX+this.size*f+25;t=this.gX-120;s=this.gY-10;r.clearRect(u,s,120,64);r.clearRect(t,s,120,64);return[r,this.gY,t,u]};q.prototype.showBackdrop=function(){var r;r=this.layers[d];this.cls(r);return r.drawImage(this.bgImg,0,0)};q.prototype.drawMisc=function(){var s,r,t;s=this.layers[h];r=120;t=64;this.drawMiscEx(s,"Human ","#ddd",this.gX-r,t,'"X"',b);return this.drawMiscEx(s,"Cyborg ","#ddd",this.gX+this.size*f+25,t,'"O"',o)};q.prototype.drawMiscEx=function(t,u,A,r,B,v,z){var s;t.font="14px 'Architects Daughter'";t.lineWidth=2;t.fillStyle=A;t.textAlign="left";t.textBaseline="bottom";s=t.measureText(u).width;t.fillText(u,r,B);t.fillStyle=z;return t.fillText(v,r+s,B)};q.prototype.drawGrid=function(){var F,z,A,r,E,t,s,C,D,B,v,w,u;F=this.layers[h];F.strokeStyle=c;F.lineWidth=1;A=this.size*f;E=(F.canvas.width-A)/2;C=100;F.strokeRect(E,C,A,A);this.gX=E;this.gY=C;r={stroke:{style:c},line:{width:1}};u=[];for(z=v=1,w=this.size;1<=w?v<w:v>w;z=1<=w?++v:--v){t=E+z*f;D=C;s=t;B=D+A;new g(t,D,s,B).draw(F,r);D=C+z*f;t=E;s=t+A;B=D;u.push(new g(t,D,s,B).draw(F,r))}return u};q.prototype.endGame=function(r){var s;switch(r){case this.X:s="Human Wins!";break;case this.O:s="Cyborg Wins!";break;default:s="It's a draw!"}s=s+" Play again?";this.updateScoreBoard(r);this.nukeGame();return this.showMsg(s)};q.prototype.updateScoreBoard=function(u){var r,t,v;switch(u){case this.X:this.scoreX+=1;v=this.scoreX;r=i("#scoreX");break;case this.O:this.scoreO+=1;v=this.scoreO;r=i("#scoreO");break;default:return}t=v<10?"00":v<100?"0":"";t=t+v;return r.text(t)};q.prototype.checkInput=function(r){var s;s=r[2];if(this.grid[s]!==0){return this.showMsg("Invalid move, try again!")}else{this.grid[s]=this.curActor===this.X?-1:1;this.drawCell(r);return this.checkWin()}};q.prototype.showMsg=function(t){var s,r,u;s=this.layers[p];s.font="14px 'Architects Daughter'";s.fillStyle="#dddddd";s.textAlign="left";s.textBaseline="bottom";r=this.gX-120;u=this.gY+this.size*f+64;s.clearRect(r,u-36,400,36);return s.fillText(t,r,u)};q.prototype.checkOffset=function(A,z){var t,w,s,r,B,u,v;t=-1;B=-1;s=this.gX;r=this.gY;for(w=u=0,v=this.size;0<=v?u<v:u>v;w=0<=v?++u:--u){if(A>s&&A<(s+f)){t=w}if(z>r&&z<(r+f)){B=w}s+=f;r+=f}if(t>=0&&B>=0){return[B,t,B*this.size+t]}else{return null}};q.prototype.offset=function(r){var u,t,s;s=i("#tictactoe #layers").offset();u=r.pageX-s.left;t=r.pageY-s.top;return[u,t]};q.prototype.drawCell=function(z){var w,E,t,F,s,D,v,u,B,C,A;E=this.layers[p];F=z[0];w=z[1];v=this.gX+w*f;C=this.gY+F*f;u=v+f;A=C+f;D=(u-v)/2;B=(A-C)/2;t=f/2-8;s={stroke:{style:c},line:{width:3}};if(this.grid[z[2]]===-1){s.stroke.style=b;s.line.cap="round";new g(v+D-t,C+B-t,v+D+t,C+B+t,3).draw(E,s);return new g(v+D+t,C+B-t,v+D-t,C+B+t,3).draw(E,s)}else{s.stroke.style=o;return new a(v+D,C+B,t,3).draw(E,s)}};q.prototype.maybeEnableInputs=function(){return i("#tictactoe #level").removeAttr("disabled")};q.prototype.maybeDisableInputs=function(){return i("#tictactoe #level").attr("disabled","disabled")};q.prototype.clsArena=function(){this.cls(this.layers[p]);this.cls(this.layers[h]);this.drawGrid();return this.drawMisc()};q.prototype.inizGameData=function(){var t,x,v,u,w,r,y,s;this.curActor=Math.floor(Math.random()*10)>5?this.X:this.O;this.grid=[];this.dx=[];this.dy=[];for(t=x=0,w=this.cells;0<=w?x<w:x>w;t=0<=w?++x:--x){this.grid[t]=0}for(t=v=0,r=this.size;0<=r?v<r:v>r;t=0<=r?++v:--v){this.dx[t]=0;this.dy[t]=0}this.dx[0]=this.size-1;this.dy[0]=0;s=[];for(t=u=1,y=this.size;1<=y?u<y:u>y;t=1<=y?++u:--u){this.dx[t]=this.dx[t-1]+this.size-1;s.push(this.dy[t]=this.dy[t-1]+this.size+1)}return s};q.prototype.toggleActor=function(){var r,s;this.curActor=this.curActor===this.X?this.O:this.X;s=this;r=function(){if(s.curActor===s.O){return setTimeout(function(){return s.cyborgMove()},2000)}};return this.syncPlayerState(r)};q.prototype.cyborgMove=function(){switch(this.level){case 1:return this.cyborgCasual();case 2:return this.cyborgNormal();case 3:return this.cyborg()}};q.prototype.cyborgCasual=function(){if(!this.scanForEasyWin()){return this.randomMove()}};q.prototype.cyborgNormal=function(){if(!this.scanForEasyWin()){if(!this.defendNeeded()){return this.randomMove()}}};q.prototype.cyborg=function(){if(!this.scanForEasyWin()){if(!this.defendNeeded()){return this.calcBestMove()}}};q.prototype.cyborgMakesMove=function(r){if(this.gameInProgress===false){return this.onStopReset()}else{this.grid[r]=1;this.drawCell(this.cellToRC(r));return this.checkWin()}};q.prototype.defendNeeded=function(){var r,t,s,u,w,v;t=this.level<3?Math.floor(Math.random()*10)>5:true;if(t){u=this;r=function(x){return u.cyborgMakesMove(x)};for(s=w=0,v=this.GOALSPACE.length;0<=v?w<v:w>v;s=0<=v?++w:--w){if(this.poisedToWin(this.GOALSPACE[s],this.X+1,r)){return true}}}return false};q.prototype.calcBestMove=function(){var y,u,s,t,x,v,w,r;y=[];for(u=x=0,w=this.dx.length;0<=w?x<w:x>w;u=0<=w?++x:--x){if(this.grid[this.dx[u]]===0){y.push(this.dx[u])}}for(u=v=0,r=this.dy.length;0<=r?v<r:v>r;u=0<=r?++v:--v){if(this.grid[this.dy[u]]===0){y.push(this.dy[u])}}s=y.length;if(s>0){t=y[Math.floor(Math.random()*s)];return this.cyborgMakesMove(t)}else{return this.randomMove()}};q.prototype.randomMove=function(){var r;r=this.nextFreeCell();if(r===-1){return this.endGame(911)}else{return this.cyborgMakesMove(r)}};q.prototype.scanForEasyWin=function(){var r,s,t,v,u;t=this;r=function(w){return t.cyborgMakesMove(w)};for(s=v=0,u=this.GOALSPACE.length;0<=u?v<u:v>u;s=0<=u?++v:--v){if(this.poisedToWin(this.GOALSPACE[s],this.O-1,r)){return true}}return false};q.prototype.poisedToWin=function(A,x,r){var u,y,z,w,B,s,t;z=-1;w=0;y=this;for(u=s=0,t=A.length;0<=t?s<t:s>t;u=0<=t?++s:--s){B=this.grid[A[u]];w+=B;if(B===0){z=A[u]}}if(w===x){setTimeout(function(){return r(z)},0);return true}else{return false}};q.prototype.cellToRC=function(r){return[Math.floor(r/this.size),r%this.size,r]};q.prototype.nextFreeCell=function(){var s,r,t;s=[];m.each(this.grid,function(u,w){if(u===0){return s.push(w)}});r=s.length;t=Math.floor(Math.random()*r);if(r===0){return -1}else{return s[t]}};q.prototype.mapGoalSpace=function(){var B,A,r,y,x,v,t,z,w,u,s;this.GOALSPACE=[];B=[];for(A=y=0,z=this.cells;0<=z?y<z:y>z;A=0<=z?++y:--y){B.push(A);if(((A+1)%this.size)===0){this.GOALSPACE.push(B);B=[]}}B=[];for(A=x=0,w=this.size;0<=w?x<w:x>w;A=0<=w?++x:--x){r=A;while(r<this.cells){B.push(r);r+=this.size}this.GOALSPACE.push(B);B=[]}B=[];B[0]=this.size-1;for(A=v=1,u=this.size;1<=u?v<u:v>u;A=1<=u?++v:--v){B[A]=B[A-1]+this.size-1}this.GOALSPACE.push(B);B=[];B[0]=0;for(A=t=1,s=this.size;1<=s?t<s:t>s;A=1<=s?++t:--t){B[A]=B[A-1]+this.size+1}this.GOALSPACE.push(B);return B=[]};q.prototype.styleText=function(r,s){r.font=s.font;r.fillStyle=s.fill;r.textAlign=s.align;r.textBaseline=s.base;return r};q.prototype.run=function(){return this.loadAssets()};return q})();i(function(){new n(3,1).run()})});